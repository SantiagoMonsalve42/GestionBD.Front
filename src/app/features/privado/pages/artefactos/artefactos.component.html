<div class="artefactos-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <p-button
    label="Regresar"
    icon="pi pi-arrow-left"
    appBack 
    styleClass="p-button-success mb-2">
  </p-button>

  <div class="flex flex-wrap gap-3 mt-3">
    <!-- Main Content: col-9 -->
    <div class="flex-1" >
      <p-card>
        <ng-template pTemplate="header">
          <div class="card-header">
            <h2>Artefactos del Entregable</h2>
            @if (entregable) {
              <div class="entregable-info">
                <span><strong>N° Entrega:</strong> {{ entregable.numeroEntrega }}</span>
                <span><strong>Descripción:</strong> {{ entregable.descripcionEntregable }}</span>
                <span><strong>Estado:</strong> {{ entregable.estadoEntrega }}</span>
              </div>
            }
          </div>
        </ng-template>

        @if (artefactos.length === 0) {
          <div class="empty-state">
            <i class="pi pi-inbox" style="font-size: 3rem; color: #94a3b8;"></i>
            <p>No hay artefactos para este entregable</p>
          </div>
        } @else {
          <div class="artefactos-info">
            <p-tag icon="pi pi-info-circle" severity="info" [value]="'Total: ' + artefactos.length + ' artefactos'"></p-tag>
            <p-tag icon="pi pi-arrows-v" severity="secondary" value="Arrastra para reordenar"></p-tag>
          </div>

          <div 
            cdkDropList 
            class="artefactos-list"
            (cdkDropListDropped)="drop($event)">
            
            @for (artefacto of artefactos; track artefacto.idArtefacto) {
              <div class="artefacto-item" cdkDrag>
                <div class="drag-handle" cdkDragHandle>
                  <i class="pi pi-bars"></i>
                </div>
                
                <div class="artefacto-order">
                  <span class="order-badge">{{ artefacto.ordenEjecucion }}</span>
                </div>

                <div class="artefacto-icon">
                  <i 
                    class="pi" 
                    [ngClass]="getArtefactoIcon(artefacto.codificacion)"
                    [style.color]="getArtefactoColor(artefacto.codificacion)">
                  </i>
                </div>

                <div class="artefacto-content">
                  <div class="artefacto-header">
                    <h4>{{ artefacto.nombreArtefacto }}</h4>
                    @if (artefacto.esReverso) {
                      <p-tag severity="danger" value="Reverso" icon="pi pi-undo"></p-tag>
                    }
                  </div>
                  
                </div>

                <div class="cdk-drag-placeholder"></div>
              </div>
            }
          </div>
        }
      </p-card>
    </div>

    <!-- Right Column: col-3 (Empty for future development) -->
    <div class="flex-1">
      <p-card>
        <ng-template pTemplate="header">
          <div class="card-header">
            <h3>Acciones</h3>
          </div>
        </ng-template>
        <div class="placeholder-content">
            <p-button label="Preparacion ambiente"
                     [disabled]="preparacionDisabled" 
                     styleClass="w-full"
                     (click)="prepararAmbiente()" />
            <p-button label="Pre-Despliegue" 
                      [disabled]="predespliegueDisabled" 
                      styleClass="w-full"
                      (click)="preDeploy()" />
            <p-button label="Despliegue" 
                      [disabled]="despliegueDisabled" 
                      styleClass="w-full"
                      (click)="deploy()"
                       />
            <p-button label="Revisión" 
                      [disabled]="revisionDisabled" 
                      styleClass="w-full"
                      (click)="revision()" />
        </div>
      </p-card>
    </div>
  </div>
</div>

<!-- Modal Pre-Deploy Results -->
<p-dialog 
  [(visible)]="displayPreDeployModal" 
  [modal]="true" 
  [style]="{width: '90vw', maxWidth: '1200px'}"
  [draggable]="false"
  [resizable]="false"
  styleClass="pre-deploy-dialog">
  
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-file-check text-3xl"></i>
      <span class="font-bold text-xl">Resultados del Pre-Despliegue</span>
    </div>
  </ng-template>

  <p-table 
    [value]="preDeployResults" 
    [paginator]="true" 
    [rows]="rowsPerPage"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} resultados"
    styleClass="p-datatable-striped"
    [tableStyle]="{'min-width': '100%'}">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 10%">Estado</th>
        <th style="width: 25%">Script</th>
        <th style="width: 15%">Status</th>
        <th style="width: 25%">Mensaje</th>
        <th style="width: 25%">Información Adicional</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-result>
      <tr>
        <td class="text-center">
          <p-tag 
            [severity]="result.isValid ? 'success':'warn'"
            [value]="result.isValid ? 'Válido' : 'Inválido'"
            [icon]="getStatusIcon(result.isValid)">
          </p-tag>
        </td>
        <td>
          <span class="font-mono text-sm">{{ result.script }}</span>
        </td>
        <td>
          <p-tag 
            [severity]="result.isValid ? 'success':'warn'"
            [value]="result.status">
          </p-tag>
        </td>
        <td>
          <div class="message-cell">
            {{ result.message }}
          </div>
        </td>
        <td>
          <div class="info-cell">
            {{ result.additionalInfo || '-' }}
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center p-4">
          <i class="pi pi-inbox text-4xl text-400 mb-2"></i>
          <p class="text-500">No hay resultados para mostrar</p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cerrar" 
        icon="pi pi-times" 
        (onClick)="closePreDeployModal()"
        styleClass="p-button-secondary">
      </p-button>
    </div>
  </ng-template>
</p-dialog>
